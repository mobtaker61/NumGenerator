<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>Digit Permuter • Mini App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg: #ffffff; --fg: #111111; --muted: #666; --btn: #0a84ff; --btn-fg: #fff; --border:#e5e7eb;
    }
    body.dark { --bg:#1c1c1e; --fg:#f2f2f7; --muted:#a1a1aa; --btn:#2f7cff; --btn-fg:#fff; --border:#2a2a2d; }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--fg);padding:18px}
    .card{max-width:560px;margin:0 auto;border:1px solid var(--border);border-radius:16px;padding:20px;background:var(--bg);box-shadow:0 2px 10px rgba(0,0,0,.06)}
    h1{font-size:18px;margin:0 0 12px}
    p{margin:0 0 16px;color:var(--muted);line-height:1.6}
    .row{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:12px}
    .digit{width:100%;border:1px solid var(--border);border-radius:12px;padding:14px 0;text-align:center;font-size:22px;background:transparent;color:var(--fg)}
    .digit:focus{outline:2px solid var(--btn);border-color:transparent}
    .actions{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-top:8px}
    button{border:none;border-radius:12px;padding:12px 16px;font-size:16px;cursor:pointer}
    #sendBtn{background:var(--btn);color:var(--btn-fg);flex:1}
    #clearBtn{background:transparent;color:var(--muted);border:1px solid var(--border)}
    .hint{font-size:13px;color:var(--muted);margin-top:10px}
    .results{margin-top:16px;border-top:1px dashed var(--border);padding-top:12px}
    .badge{display:inline-block;background:var(--border);color:var(--fg);padding:4px 8px;border-radius:999px;font-size:12px;margin-bottom:8px}
    .list{max-height:260px;overflow:auto;border:1px solid var(--border);border-radius:12px;padding:10px;font-family:ui-monospace,Menlo,monospace;line-height:1.6}
    .toolbar{display:flex;gap:8px;margin-bottom:8px}
    .ghost{opacity:.5}
  </style>
</head>
<body>
  <div class="card">
    <h1>تولید همهٔ ترکیب‌های یکتا از ۴ رقم</h1>
    <p>هر فیلد فقط یک رقم ۰ تا ۹ می‌گیرد و به‌طور خودکار به بعدی می‌رود. نتیجه هم اینجا نمایش داده می‌شود و هم برای ربات ارسال می‌گردد.</p>

    <div class="row">
      <input id="d1" class="digit" type="tel" inputmode="numeric" maxlength="1" placeholder="۰">
      <input id="d2" class="digit" type="tel" inputmode="numeric" maxlength="1" placeholder="۰">
      <input id="d3" class="digit" type="tel" inputmode="numeric" maxlength="1" placeholder="۰">
      <input id="d4" class="digit" type="tel" inputmode="numeric" maxlength="1" placeholder="۰">
    </div>

    <div class="actions">
      <button id="clearBtn" type="button">پاک‌سازی</button>
      <button id="sendBtn" type="button" disabled>ارسال به ربات</button>
    </div>

    <div class="hint" id="status">Status: آماده</div>

    <div class="results" id="results" hidden>
      <div class="toolbar">
        <span class="badge" id="countBadge">۰ مورد</span>
        <button id="copyBtn" type="button">کپی همه</button>
        <button id="downloadBtn" type="button">دانلود txt</button>
      </div>
      <div class="list" id="list"></div>
    </div>

    <div class="hint">نکته: اگر رقم تکراری بدهید، تعداد حالات کمتر از ۲۴ خواهد شد (مثلاً ۰ ۹ ۹ ۱ → ۱۲ حالت).</div>
  </div>

  <script>
    const tg = window.Telegram?.WebApp;
    const inputs = [...document.querySelectorAll('.digit')];
    const [d1,d2,d3,d4] = inputs;
    const sendBtn = document.getElementById('sendBtn');
    const clearBtn = document.getElementById('clearBtn');
    const statusEl = document.getElementById('status');
    const resultsEl = document.getElementById('results');
    const listEl = document.getElementById('list');
    const countBadge = document.getElementById('countBadge');
    const copyBtn = document.getElementById('copyBtn');
    const downloadBtn = document.getElementById('downloadBtn');

    // تم تلگرام
    function applyTheme(){
      const scheme = tg?.colorScheme || 'light';
      document.body.classList.toggle('dark', scheme === 'dark');
      tg?.expand?.();
    }
    applyTheme();
    tg?.onEvent?.('themeChanged', applyTheme);

    // مبدل ارقام فارسی/عربی به لاتین
    const faDigits = '۰۱۲۳۴۵۶۷۸۹';
    const arDigits = '٠١٢٣٤٥٦٧٨٩';
    function toLatinDigit(ch){
      const i1 = faDigits.indexOf(ch), i2 = arDigits.indexOf(ch);
      if(i1 !== -1) return String(i1);
      if(i2 !== -1) return String(i2);
      return ch;
    }

    function sanitize(v){
      if(!v) return '';
      v = toLatinDigit(v.slice(-1));     // فقط آخرین کاراکتر
      return /^\d$/.test(v) ? v : '';
    }

    // فعال/غیرفعال کردن دکمه ارسال
    function updateSendState(){
      const ok = inputs.every(el => /^\d$/.test(el.value));
      sendBtn.disabled = !ok;
      sendBtn.classList.toggle('ghost', !ok);
    }

    // فوکوس خودکار و هندل Backspace/Arrow
    inputs.forEach((el, idx) => {
      el.addEventListener('input', (e) => {
        el.value = sanitize(el.value);
        if(el.value && idx < inputs.length - 1) inputs[idx+1].focus();
        updateSendState();
        // نمایش پیش‌نمایش محلی هر بار که ۴ رقم کامل شد
        if(inputs.every(i => i.value)){
          renderLocalResults(getDigits());
        }
      });
      el.addEventListener('keydown', (e) => {
        if(e.key === 'Backspace' && !el.value && idx > 0){
          inputs[idx-1].focus(); inputs[idx-1].value = ''; updateSendState();
          e.preventDefault();
        }
        if(e.key === 'ArrowLeft' && idx > 0){ inputs[idx-1].focus(); e.preventDefault(); }
        if(e.key === 'ArrowRight' && idx < inputs.length-1){ inputs[idx+1].focus(); e.preventDefault(); }
        if(e.key === 'Enter'){ sendBtn.click(); }
      });
      // جلوگیری از Paste چندکاراکتری
      el.addEventListener('paste', (e) => {
        e.preventDefault();
        const data = (e.clipboardData.getData('text') || '').split('').map(toLatinDigit).filter(c => /^\d$/.test(c));
        for(let i=0;i<data.length && idx+i<inputs.length;i++){
          inputs[idx+i].value = data[i];
        }
        (inputs[idx + Math.min(data.length, inputs.length-1-idx)] || el).focus();
        updateSendState();
        if(inputs.every(i => i.value)) renderLocalResults(getDigits());
      });
    });

    function getDigits(){ return inputs.map(el => Number(el.value)); }
    function setStatus(msg){ statusEl.textContent = 'Status: ' + msg; }

    // تولید جایگشت‌ها (بدون تکرار) در خود کلاینت
    function permutations4(d){
      const set = new Set();
      function rec(path, used){
        if(path.length === 4){ set.add(path.join('')); return; }
        for(let i=0;i<4;i++){
          if(used[i]) continue;
          used[i]=true; path.push(d[i]);
          rec(path, used);
          path.pop(); used[i]=false;
        }
      }
      rec([], Array(4).fill(false));
      // shuffle
      const arr = [...set];
      for(let i=arr.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]];
      }
      return arr;
    }

    function renderLocalResults(digits){
      const combos = permutations4(digits);
      countBadge.textContent = combos.length + ' مورد';
      listEl.innerHTML = combos.map(c => `<div>${c}</div>`).join('');
      resultsEl.hidden = false;
    }

    // ارسال به ربات و همچنین نمایش محلی
    document.getElementById('sendBtn').onclick = function(){
      if(sendBtn.disabled) return;
      const digits = getDigits();
      renderLocalResults(digits); // نمایش همان‌جا
      if(!tg || !tg.sendData){ setStatus('WebApp در دسترس نیست. از داخل چت ربات باز کنید.'); return; }
      tg.sendData(JSON.stringify({ source:"miniapp", digits }));
      setStatus('ارسال شد. نتیجه در چت ربات هم می‌آید.');
      // اگر می‌خواهی بعد از ارسال بسته شود، خط زیر را باز کن:
      // tg.close();
    };

    // پاک‌سازی
    clearBtn.onclick = function(){
      inputs.forEach(el => el.value='');
      resultsEl.hidden = true; listEl.innerHTML=''; countBadge.textContent='۰ مورد';
      setStatus('آماده');
      d1.focus();
      updateSendState();
    };

    // کپی و دانلود
    copyBtn.onclick = async function(){
      const text = [...listEl.querySelectorAll('div')].map(d=>d.textContent).join('\n');
      try { await navigator.clipboard.writeText(text); setStatus('کپی شد.'); } catch{ setStatus('کپی ناموفق.'); }
    };
    downloadBtn.onclick = function(){
      const text = [...listEl.querySelectorAll('div')].map(d=>d.textContent).join('\n');
      const blob = new Blob([text], {type:'text/plain'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'permutations.txt';
      a.click();
      URL.revokeObjectURL(a.href);
    };

    // شروع
    d1.focus();
    updateSendState();
  </script>
</body>
</html>
